---

# Include once to write/set, include a second time to remove/clear

- name: Handle clouds.yaml
  hosts: instances
  connection: local
  become: false
  tasks:
    - name: Write clouds.yaml
      copy:
        content: "{{ item.content }}"
        dest: "{{ inventory_dir }}/{{ item.dest }}"
        mode: "0400"
      with_items:
        - { dest: "clouds.yaml", content: "{{ clouds_yaml | to_nice_yaml }}" }
        - { dest: "swarm_kp.pem", content: "{{ swarm_ssh_key }}" }
      delegate_to: localhost
      run_once: yes
    - name: Set cloud fact
      set_fact:
        clouds: "{{ clouds_yaml.clouds }}"
      delegate_to: localhost
